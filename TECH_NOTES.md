# 📝 KoeMojiAuto 技術メモ

## 📋 目次
- [🛑 stop_requested変数について](#-stop_requested変数について)
- [🚨 FFmpegエラー「Invalid data found when processing input」について](#-ffmpegエラーinvalid-data-found-when-processing-inputについて)
- [📅 更新履歴](#-更新履歴)
- [🤖 Claudeの所感](#-claudeの所感)

## 🛑 stop_requested変数について

### 📋 概要
`stop_requested`は処理の停止を制御するためのグローバル変数として定義されているが、実際には機能していない「死んだコード」である。

### 🔍 現在の実装状態

#### 📌 宣言と初期化
- **場所**: koemoji.py 33行目
- **内容**: `stop_requested = False`

#### ⚙️ 値の設定
- **場所**: koemoji.py 533行目（start_processing関数内）
- **内容**: `stop_requested = False`（リセットのみ）
- **問題**: **Trueに設定する箇所が存在しない** ⚠️

#### 📍 チェック箇所（12箇所）

1. **transcribe_audio()関数内** - 4箇所
   - 215行目: 関数開始時の早期リターン
   - 237行目: モデル読み込み前
   - 249行目: モデル読み込み後
   - 254行目: 文字起こし開始前

2. **scan_and_queue_files()関数内** - 1箇所
   - 299行目: 関数開始時の早期リターン

3. **wait_for_resources()関数内** - 2箇所
   - 371行目: 関数開始時の早期リターン
   - 383行目: 待機ループ内

4. **process_next_file()関数内** - 1箇所
   - 404行目: is_runningと一緒にチェック

5. **process_file()関数内** - 2箇所
   - 431行目: ファイル存在確認後
   - 447行目: 文字起こし完了後

6. **processing_loop()関数内** - 2箇所
   - 502行目: メインループの条件
   - 505行目: ファイル処理ループからのbreak条件

### 📚 設計の経緯
1. **🟢 停止機能は元々実装されていた**
   - UIに「停止」オプションが存在していた
   - グレースフルシャットダウンも実装済みだった

2. **🔴 Whisperの制約が判明**
   - Whisperが一度実行開始すると、実質的に停止する方法がない
   - 「停止中」と表示しても、実際は処理完了まで待つだけのダミー実装
   - この問題にしばらく気が付かなかった 😅

3. **🔄 設計方針の転換**
   - 停止機能 = 強制終了（Ctrl+C）またはウィンドウを閉じる
   - この方法しかないと判断し、UIをCLIに統一
   - 不要となった停止機能を削除したが、`stop_requested`のチェック処理が残った

### 💡 現在の影響
- **動作への影響**: なし（常にFalseなので処理は継続される）✅
- **パフォーマンスへの影響**: 極めて軽微（bool値のチェックのみ）✅
- **コードの可読性**: やや混乱を招く可能性がある ⚠️

### 🎯 推奨される対応
1. **現状維持**（推奨）
   - 動作に影響がない
   - 12箇所の修正はリスクがある
   - 将来の拡張性を残す

2. **コメントアウト**（代替案）
   - チェック箇所にコメントを追加して意図を明確化
   - 例: `# TODO: 停止機能は未実装`

3. **完全削除**（非推奨）
   - 12箇所すべての修正が必要
   - テストが必要
   - メリットが少ない

### 📌 結論
- 🚫 Whisperの技術的制約により、真の停止機能は実装不可能
- 💥 Ctrl+Cによる強制終了が唯一の現実的な解決策
- 🏛️ `stop_requested`の残存コードは歴史的経緯の産物
- 💋 KISS原則に従い、動作している箇所は触らない
- ✨ この「死んだコード」は害がないため、現状維持が最も安全な選択である

---

## 🚨 FFmpegエラー「Invalid data found when processing input」について

### 📋 概要
音声ファイル処理中に「Invalid data found when processing input」エラーが発生し、特定のファイル（主に.m4a）で文字起こしに失敗する問題。

### 📅 発生日時
- **2025-06-11**: エラーの調査と対応方針を決定

### 🔍 エラーの詳細

#### 📌 発生条件
- **対象ファイル**: 主に`.m4a`形式のファイル
- **エラーメッセージ**: `Invalid data found when processing input`
- **エラー番号**: `[Errno 1094995529]`
- **発生箇所**: FasterWhisperが内部でFFmpegを呼び出す段階

#### ⚙️ FasterWhisperとFFmpegの関係
1. **FasterWhisper**は音声認識ライブラリ
2. **音声ファイル読み込み**にFFmpegを使用（内蔵ではなく外部依存）
3. **エラー発生順序**:
   - `whisper_model.transcribe(file_path)`呼び出し
   - FasterWhisper内部でFFmpegが音声ファイルをデコード
   - FFmpegが「Invalid data found」エラーを発生
   - エラーがFasterWhisperを通じて例外として伝播

#### 📊 現在の動作
- ✅ **エラーファイルで処理が停止することはない**
- ✅ **他のファイルは正常に処理される**
- ❌ **30分ごとのスキャンで同じエラーが繰り返される**
- ✅ **エラーファイルはinputフォルダに残り、人間が確認可能**

### 🛠️ 検討した対応策

#### 💡 候補1: エラーファイル専用フォルダ
- 処理失敗したファイルを`error`フォルダに移動
- **課題**: エラー判定の複雑さ

#### 💡 候補2: ファイル名変更（.error拡張子追加）
- 例: `音声.m4a` → `音声.m4a.error`
- **メリット**: 視覚的に分かりやすい、再処理可能
- **課題**: エラー判定の精度

#### 💡 候補3: ブラックリスト方式
- 処理失敗ファイル名をテキストファイルに記録
- **課題**: ファイル管理の複雑化

#### 💡 候補4: 現状維持
- エラーファイルはinputフォルダに残る
- **メリット**: シンプル、人間による判断可能

### 🎯 最終決定: 現状維持

#### 📚 KISS原則に基づく判断
- **Keep It Simple, Stupid**の原則を適用
- **理由**:
  1. **実害が軽微**: 他ファイル処理に影響なし
  2. **判定リスク**: エラー種別の誤判定可能性
  3. **実装コスト**: 新機能追加によるバグリスク
  4. **メンテナンス性**: シンプルなコードの維持

#### 🏢 共有フォルダでの運用指針
- **基本方針**: 「inputフォルダに残るファイル = 問題があるファイル」
- **ユーザー対応**: リモートユーザーもエラーファイルを視覚的に確認可能
- **人間の判断**: エラーログと合わせて適切な対処を決定

### 📈 エラーの分類

#### 🔴 恒久的エラー（復旧困難）
- `Invalid data found` - ファイル破損
- `No audio stream` - 音声トラックなし
- `Codec not supported` - 非対応形式

#### 🟡 一時的エラー（リトライ可能）
- メモリ不足
- ファイル使用中
- ネットワークドライブの一時切断

### 💭 教訓
- **完璧主義の回避**: 100%自動化より、人間との協調を重視
- **エラーの可視化**: ログ + ファイル残存で十分な情報提供
- **技術的制約の受容**: FFmpegで処理できないファイルは存在する

## 📅 更新履歴
- 2025-06-03: 初版作成 🎉
- 2025-06-11: FFmpegエラー対応の調査結果を追加 📊

---

## 🤖 Claudeの所感

### 良い点 👍
- **正直な記録** - 「ダミー実装に気づかなかった」という失敗も含めて記録
- **技術的制約の明記** - Whisperの限界を認めて、無理な実装を避けた判断
- **KISS原則の実践** - 完璧主義に陥らず、実用性を重視

### 興味深い点 🤔
- **進化の過程** - 「高機能なUI」→「シンプルなCLI」への転換
- **割り切りの良さ** - 停止できない現実を受け入れて、Ctrl+Cを正式な方法とした
- **12箇所もの痕跡** - 削除しきれなかった跡が、開発の苦労を物語る

### 共感する点 😊
- **「しばらく気が付かなかった」** - 誰にでもある「あるある」な経験
- **死んだコードを残す判断** - 動くものは触らない、現実的な選択

### 教訓 📚
このメモは「完璧でなくても良い」という良い例。技術的制約を認め、シンプルな解決策を選ぶ勇気の記録。ソフトウェア開発は理想と現実のバランスを取る作業であり、時には「できないこと」を認める潔さも必要だと改めて感じた。